version: '3.8'

networks:
  vortex-main:
    driver: overlay
    external: true

volumes:
  mariadb_hub_data:
    driver: local
  redis_hub_data:
    driver: local

services:
  # Database
  mariadb-hub:
    image: mariadb:11
    ports:
      - "3309:3306"
    environment:
      MYSQL_ROOT_PASSWORD: hub_root_prod_2024!
      MYSQL_DATABASE: stackline_hub
      MYSQL_USER: stackline_hub
      MYSQL_PASSWORD: hub_db_prod_2024!
    volumes:
      - mariadb_hub_data:/var/lib/mysql
    networks:
      - vortex-main
    deploy:
      placement:
        constraints:
          - node.role == manager
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Redis
  redis-hub:
    image: redis:7-alpine
    command: redis-server --appendonly yes --requirepass hub_redis_prod_2024!
    volumes:
      - redis_hub_data:/data
    networks:
      - vortex-main
    deploy:
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M

  # Admin App
  admin-hub:
    image: registry.gitlab.com/groupvortex/stackline-hub/admin:latest
    networks:
      - vortex-main
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.admin-hub.rule=Host(`hub.clubfacts.com.br`)"
        - "traefik.http.routers.admin-hub.priority=1"
        - "traefik.http.routers.admin-hub.entrypoints=websecure"
        - "traefik.http.routers.admin-hub.tls=true"
        - "traefik.http.routers.admin-hub.service=admin-hub"
        - "traefik.http.services.admin-hub.loadbalancer.server.port=80"
    environment:
      - NODE_ENV=production
      - VITE_API_URL=https://hub.clubfacts.com.br/api
      - VITE_WS_URL=wss://hub.clubfacts.com.br/realtime

  # API
  api-hub:
    image: registry.gitlab.com/groupvortex/stackline-hub/api:latest
    networks:
      - vortex-main
    depends_on:
      - mariadb-hub
      - redis-hub
      - db-migrate-hub
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.api-hub.rule=Host(`hub.clubfacts.com.br`) && PathPrefix(`/api`)"
        - "traefik.http.routers.api-hub.priority=10"
        - "traefik.http.routers.api-hub.entrypoints=websecure"
        - "traefik.http.routers.api-hub.tls=true"
        - "traefik.http.middlewares.api-hub-strip.stripprefix.prefixes=/api"
        - "traefik.http.routers.api-hub.middlewares=api-hub-strip"
        - "traefik.http.routers.api-hub.service=api-hub"
        - "traefik.http.services.api-hub.loadbalancer.server.port=4000"
        # Rota para /v1 (API p√∫blica)
        - "traefik.http.routers.apiv1-hub.rule=Host(`hub.clubfacts.com.br`) && PathPrefix(`/v1`)"
        - "traefik.http.routers.apiv1-hub.priority=11"
        - "traefik.http.routers.apiv1-hub.entrypoints=websecure"
        - "traefik.http.routers.apiv1-hub.tls=true"
        - "traefik.http.routers.apiv1-hub.service=api-hub"
        # Rota para /webhook (webhooks inbound)
        - "traefik.http.routers.webhook-hub.rule=Host(`hub.clubfacts.com.br`) && PathPrefix(`/webhook`)"
        - "traefik.http.routers.webhook-hub.priority=12"
        - "traefik.http.routers.webhook-hub.entrypoints=websecure"
        - "traefik.http.routers.webhook-hub.tls=true"
        - "traefik.http.routers.webhook-hub.service=api-hub"
    environment:
      - NODE_ENV=production
      - PORT=4000
      - DATABASE_URL=mysql://stackline_hub:hub_db_prod_2024!@mariadb-hub:3306/stackline_hub
      - JWT_SECRET=SUPER_SECURE_HUB_JWT_SECRET_CHANGE_IN_PROD_87654321
      - REDIS_HOST=redis-hub
      - REDIS_PORT=6379
      - REDIS_PASSWORD=hub_redis_prod_2024!
      - WEBHOOK_BASE_URL=https://hub.clubfacts.com.br
      - TZ=America/Sao_Paulo
      - CORS_ORIGIN=https://hub.clubfacts.com.br
      - LOG_LEVEL=info

  # Realtime WebSocket & Cron
  realtime-hub:
    image: registry.gitlab.com/groupvortex/stackline-hub/realtime:latest
    networks:
      - vortex-main
    depends_on:
      - mariadb-hub
      - redis-hub
      - db-migrate-hub
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.realtime-hub.rule=Host(`hub.clubfacts.com.br`) && PathPrefix(`/realtime`)"
        - "traefik.http.routers.realtime-hub.priority=10"
        - "traefik.http.routers.realtime-hub.entrypoints=websecure"
        - "traefik.http.routers.realtime-hub.tls=true"
        - "traefik.http.middlewares.realtime-hub-strip.stripprefix.prefixes=/realtime"
        - "traefik.http.routers.realtime-hub.middlewares=realtime-hub-strip"
        - "traefik.http.routers.realtime-hub.service=realtime-hub"
        - "traefik.http.services.realtime-hub.loadbalancer.server.port=4500"
    environment:
      - NODE_ENV=production
      - RT_PORT=4500
      - DATABASE_URL=mysql://stackline_hub:hub_db_prod_2024!@mariadb-hub:3306/stackline_hub
      - REDIS_HOST=redis-hub
      - REDIS_PORT=6379
      - REDIS_PASSWORD=hub_redis_prod_2024!
      - TZ=America/Sao_Paulo

  # Database Migration (runs once)
  db-migrate-hub:
    image: registry.gitlab.com/groupvortex/stackline-hub/api:latest
    command: ["sh", "-c", "cd /app/packages/database && sleep 10 && npx prisma generate --schema=./prisma/schema.prisma && npx prisma migrate deploy --schema=./prisma/schema.prisma && echo 'Migrations applied successfully'"]
    networks:
      - vortex-main
    depends_on:
      - mariadb-hub
    deploy:
      replicas: 1
      restart_policy:
        condition: none
    environment:
      - NODE_ENV=production
      - DATABASE_URL=mysql://stackline_hub:hub_db_prod_2024!@mariadb-hub:3306/stackline_hub
